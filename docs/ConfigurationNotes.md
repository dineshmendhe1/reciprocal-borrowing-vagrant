# Configuration Notes

The following are notes related to the configuration of the SP and IdP machines.

The configuration changes largely follow those outlined in the "redhat-7-apache-2.4" branch of the "umd-lib/tomcat-shibboleth-integration-demo" GitHub repository: [https://github.com/umd-lib/tomcat-shibboleth-integration-demo/tree/redhat-7-apache-2.4](https://github.com/umd-lib/tomcat-shibboleth-integration-demo/tree/redhat-7-apache-2.4), with changes for using Passenger instead of Tomcat on the SP.

## IdP

The IdP is not configured to the usual DSS standards regarding application locations, and the use of a "control" script. This was largely due to time constraints, and because it is unlikely that DSS will ever have to set up and manage its own IdP. In a production system, DSS-external IdP servers will be used.

Similarly, the choice of using CentOS 5.10/Apache 2.2.3 for the IdP was largely dictated by having an already existing Vagrant configuration that used those components, and it didn't seem worthwhile to attempt to update it.

Note: Where a modified file is copied in place of an existing (system-provided) file, the system-provided file was first copied with a ".dist" extension.

### apache_config/conf/httpd.conf

The only change to the stock Apache httpd.conf is that the following lines are appended to the end of the file:

```
ProxyPass /idp/ ajp://localhost:8009/idp/

<Location /idp/Authn/RemoteUser>
  AuthType Basic
  AuthName "My Identity Provider"
  AuthUserFile /usr/local/idp/credentials/user.db
  require valid-user
</Location>
```

This simply causes the IdP to use "Basic" HTTP authentication, using the users/passwords in the /usr/local/idp/credentials/user.db as the authentication source.

The "ProxyPass" line is used to communicate with the IdP running on Tomcat.

### idp_config/conf/relying-party.xml

This file was modified with the following lines being appended into the "Metadata Configuration" section:

```
        <metadata:MetadataProvider id="URLMD" xsi:type="metadata:FileBackedHTTPMetadataProvider"
                          metadataURL="http://192.168.33.20/Shibboleth.sso/Metadata"
                          backingFile="/apps/shibboleth-idp/metadata/some-metadata.xml" />
```

This modifies the IdP to use the "/apps/shibboleth-idp/metadata/some-metadata.xml" as the metadata source for the SP. The "some-metadata.xml" file (described below) includes the public key to use in communicating with the SP, as well as the "AssertionConsumerService" endpoints.

These changes make it so the IdP "recognizes" the SP and can communicate with it.

### vm-setup/idp_config/conf/attribute-resolver.xml

Modified so that the "eduPersonAffiliation" and "eduPersonEntitlement" attributes will be passed to the SP. These attributes will "stand in" as an example of Shibboleth attribute passing. In production systems, different (and more useful) attributes will be passed.

Changes consist of uncommenting the "eduPersonAffiliation" and "eduPersonEntitlement" attribute stanzas in the "Attribute Definitions" section, and modifying them to use "staticAttributes" instead of "myLDAP". Also uncommented (in the "Data Connectors" section) was the "Example Static Connector", which sets values for the "eduPersonAffiliation" and "eduPersonEntitlement" attributes.

### vm-setup/idp_config/conf/attributes-filter.xml

Added the following lines to the file (just above the final "</afp:AttributeFilterPolicyGroup>" tag):

```
    <!--
         Release eduPersonAffiliation and eduPersonEntitlement to SP
    -->
    <afp:AttributeFilterPolicy>
        <afp:PolicyRequirementRule xsi:type="basic:AttributeRequesterString" 
                                   value="https://192.168.33.20/shibboleth" />
        <afp:AttributeRule attributeID="eduPersonAffiliation">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>
        <afp:AttributeRule attributeID="eduPersonEntitlement">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>
    </afp:AttributeFilterPolicy>
```

This file permits the IdP to pass the "eduPersonAffiliation" and "eduPersonEntitlement" attributes to the SP.

### vm-setup/idp_config/conf/some-metadata.xml

The metadata describing the SP, including the public key the IdP should use to communicate with the SP, and the "AssertionConsumerService" endpoints describing where to redirect authentication responses.

The contents of this file are generated by the SP, by going to [https://192.168.33.20/Shibboleth.sso/Metadata](https://192.168.33.20/Shibboleth.sso/Metadata). The resulting XML is simply copied into the "some-metadata.xml" file.

This file may need to be updated if the Shibboleth private key on the SP is updated.

## SP

The SP is configured to the usual DSS standards regarding application locations, and the use of a "control" script.

For the Reciprocal Borrowing application the application director is "/apps/borrow/". The "/apps/borrow/control" script is used to start and stop the individual applications used by the SP.

One important difference is that there is no distinct "service account user" (which would typically have a name such as "borrow). Instead the default "vagrant" user is used. This is necessary because the Rails application is hosted inside the Vagrant machine as a synced directory, and there was no obvious way to make the ownership of the directory compatible with a separate service account user.

The Vagrant uses CentOS 7.2/Apache 2.4.6, as it is anticipated that this configuration will more closely match that used in production.

The configuration differs in some ways from that in the "umd-lib/tomcat-shibboleth-integration-demo" GitHub repository, largely due to the use of Ruby on Rails and Passenger Phusion, instead Java and Tomcat.

### Apache HTTP Configuration

Following standard DSS practice, the Apache configuration is stored in a directory under "/apps/" (specifically, "/apps/borrow/apache/"). So the stock Apache configuration is not touched.

#### vm-setup/apache/control

DSS-standard "control" script for starting and stopping Apache HTTP.

#### vm-setup/apache_conf/conf/env-variables

DSS-standard file containing environment variables used in the Apache HTTP configuration. Specifies the server name, and the names of the SSL certificates.

The SERVER_NAME variable is specified as "SED_HOSTNAME". The "SED_HOSTNAME" text is replaced by the IP address of the server (using the Unix "sed" tool) as part of the Vagrant machine provisioning.

The default self-signed certificates ("localhost") created by Apache in /etc/pki/tls/certs/ are used as the SSL certificates for Apache HTTP.

#### vm-setup/apache/conf/httpd.conf

The http.conf file used to configure Apache. The changes in this file consist largely of parameterizing different values with "SED_" variables so that they can be replaced with actual values as part of the Vagrant machine provisioning.

#### vm-setup/apache/conf/magic

Stock Apache HTTP "magic" file. No changes were made to the file. Copied from /etc/httpd/conf/magic

#### vm-setup/apache/conf.d/00-virtualhosts.conf

Apache configuration file used to support the Passenger Phusion configuration, SSL configuration, and make the Rails application available on the root URL (i.e., at https://192.168.33.20/). There are some "SED_" parameters set to actual values during Vagrant provisioning.

The following stanza:

```
    <Location /Shibboleth.sso>
      PassengerEnabled off
    </Location>
```

prevents Passenger from interfering with the URLs provided by the "shibd" Shibboleth SP module.

The stanza:

```
    # The directory Shibboleth requests call back to.
    <Location /callback>
      AuthType shibboleth
      ShibRequestSetting requireSession 1
      require shib-session
    </Location>
```

is used to protect the directory the Shibboleth IdP responds to with authentication responses. This ensures that the response will be processed by the "shibd" Shibboleth SP module, and make the Shibboleth attributes available to the Rails application.

#### vm-setup/apache/conf.d/passenger.conf

Stock configuration file for the Passenger Phusion Apache module. No changes were made to the file. Copied from /etc/httpd/conf.d/passenger.conf

#### vm-setup/apache/conf.d/shib.conf

Stock configuration file for Shibboleth SP module. Copied from /etc/httpd/conf.d/shib.conf

#### vm-setup/apache/html/index.html

Simple placeholder HTML file. In a working system, this file will never be displayed.

#### vm-setup/apache/html/robots.txt

robots.txt file to disallow all robot activity.

#### vm-setup/apache/src

Contains DSS standard files, "httpdctl.c" and "Makefile" for constructing an executable that can be run by the service account, and allows the Apache HTTP configuration to be set to the DSS-specified location.

Both files contains "SED_" parameters that are replaced with actual values as part of the Vagrant machine provisioning.

#### vm-setup/control_script/control

DSS-standard "control" script for starting and stopping the individual applications making up the SP.

#### vm-setup/shibboleth_config/shibboleth2.xml

Configuration file for the Shibboleth SP daemon. Modified the "ApplicationDefaults" stanza to set the entityID for the SP:

```
    <ApplicationDefaults entityID="https://192.168.33.20/shibboleth"
                         REMOTE_USER="eppn persistent-id targeted-id">
```

Added the following stanza to provide a MetadataProvider pointing to the IdP:

```
        <!-- MetadataProvider config for Vagrant IdP -->
        <MetadataProvider type="XML" uri="http://192.168.33.10/idp/profile/Metadata/SAML"
              backingFilePath="federation-metadata.xml" reloadInterval="7200">
              
            <DiscoveryFilter type="Blacklist" matcher="EntityAttributes" trimTags="true"
              attributeName="http://macedir.org/entity-category"
              attributeNameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
              attributeValue="http://refeds.org/category/hide-from-discovery" />
        </MetadataProvider>
```

#### vm-setup/shibboleth_config/sp-cert.pem

Public key for use in communicating with the SP. The key in this file will appear in the "some-metadata.xml" file on the IdP, so if this file is changed, the "some-metadata.xml" file on the IdP will also need to be updated.

This public key should **NEVER** be used on a production system.

#### vm-setup/shibboleth_config/sp-key.pem

Private key that corresponds to the public key in sp-cert.perm. If multiple SPs need to communicate with the IdP (and are added as "AssertionConsumerService" in the "some-metadata.xml" file on the IdP), each SP will need this private key.

This private key should **NEVER** be used on a production system.
