# Configuration Notes

The following are notes related to the configuration of the SP and IdP machines.

The configuration changes largely follow those outlined in the "redhat-7-apache-2.4" branch of the "umd-lib/tomcat-shibboleth-integration-demo" GitHub repository: [https://github.com/umd-lib/tomcat-shibboleth-integration-demo/tree/redhat-7-apache-2.4](https://github.com/umd-lib/tomcat-shibboleth-integration-demo/tree/redhat-7-apache-2.4), with changes for using Passenger instead of Tomcat on the SP.

Note: Where a modified file is copied in place of an existing (system-provided) file, the system-provided file was first copied with a ".dist" extension.

## IdP

The IdP is not configured to the usual DSS standards regarding application locations, and the use of a "control" script. This was largely due to time constraints, and because it is unlikely that DSS will ever have to set up and manage its own IdP. In a production system, the DSS-external IdP servers will be used.

Similarly, the choice of using CentOS 5.10/Apache 2.2.3 for the IdP was largely dictated by having an already existing Vagrant configuration that used those components, and it didn't seem worthwhile to attempt to update it.

### apache_config/conf/httpd.conf

The only change to the stock Apache httpd.conf is that the following lines are appended to the end of the file:

```
ProxyPass /idp/ ajp://localhost:8009/idp/

<Location /idp/Authn/RemoteUser>
  AuthType Basic
  AuthName "My Identity Provider"
  AuthUserFile /usr/local/idp/credentials/user.db
  require valid-user
</Location>
```

This simply causes the IdP to use "Basic" HTTP authentication, using the users/passwords in the /usr/local/idp/credentials/user.db as the authentication source.

The "ProxyPass" line is used to communicate with the IdP running on Tomcat.

### idp_config/

#### conf/relying-party.xml

This file was modified with the following lines being appended into the "Metadata Configuration" section:

```
        <metadata:MetadataProvider id="URLMD" xsi:type="metadata:FileBackedHTTPMetadataProvider"
                          metadataURL="http://192.168.33.20/Shibboleth.sso/Metadata"
                          backingFile="/apps/shibboleth-idp/metadata/some-metadata.xml" />
```

This modifies the IdP to use the "/apps/shibboleth-idp/metadata/some-metadata.xml" as the metadata source for the SP. The "some-metadata.xml" file (described below) includes the public key to use in communicating with the SP, as well as the "AssertionConsumerService" endpoints.

These changes make it so the IdP "recognizes" the SP and can communicate with it.

#### conf/attribute-resolver.xml

Modified so that the "eduPersonAffiliation" and "eduPersonEntitlement" attributes will be based into the SP. These attributes will "stand in" as an example of Shibboleth attribute passing. In production systems, different (and more useful) attributes will be passed.

Changes consist of uncommenting the "eduPersonAffiliation" and "eduPersonEntitlement" attribute stanzas in the "Attribute Definitions" section, and modifying them to use "staticAttributes" instead of "myLDAP". Also uncommented (in the "Data Connectors" section) was the "Example Static Connector", which sets values for the "eduPersonAffiliation" and "eduPersonEntitlement" attributes.

#### conf/attributes-filter.xml

Added the following lines to the file (just above the final "</afp:AttributeFilterPolicyGroup>":

```
    <!--
         Release eduPersonAffiliation and eduPersonEntitlement to SP
    -->
    <afp:AttributeFilterPolicy>
        <afp:PolicyRequirementRule xsi:type="basic:AttributeRequesterString" 
                                   value="https://192.168.33.20/shibboleth" />
        <afp:AttributeRule attributeID="eduPersonAffiliation">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>
        <afp:AttributeRule attributeID="eduPersonEntitlement">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>
    </afp:AttributeFilterPolicy>
```
This file permits the IdP to pass the "eduPersonAffiliation" and "eduPersonEntitlement" attributes to the SP.

#### conf/some-metadata.xml

The metadata describing the SP, including public key to use to communicate the IdP should use to communicate with the SP, and the "AssertionConsumerService" endpoints describing where to redirect authentication responses.

The contents of this file are generated by the SP, by going to [https://192.168.33.20/Shibboleth.sso/Metadata](https://192.168.33.20/Shibboleth.sso/Metadata). The resulting XML is simply copied into the "some-metadata.xml".

This file may need to be updated if the Shibboleth private key on the SP is updated.